generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  name      String?
  password  String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  projects  Project[]
}

model Project {
  id          String       @id @default(cuid())
  name        String
  description String?
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  subscribers Subscriber[]
  campaigns   Campaign[]

  @@index([userId])
}

model Subscriber {
  id          String       @id @default(cuid())
  email       String
  name        String?
  projectId   String
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  metadata    Json?
  subscribed  Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  emailEvents EmailEvent[]

  @@unique([email, projectId])
  @@index([projectId])
  @@index([email])
}

model Campaign {
  id          String       @id @default(cuid())
  name        String
  subject     String
  content     String       @db.Text
  projectId   String
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  status      String       @default("draft") // draft, sending, sent, failed
  sentAt      DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  emailEvents EmailEvent[]

  @@index([projectId])
  @@index([status])
}

model EmailEvent {
  id           String      @id @default(cuid())
  campaignId   String
  campaign     Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  subscriberId String
  subscriber   Subscriber  @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  status       String      // sent, delivered, failed, bounced
  resendId     String?     @unique
  sentAt       DateTime    @default(now())
  opens        OpenEvent[]
  clicks       ClickEvent[]

  @@index([campaignId])
  @@index([subscriberId])
  @@index([status])
}

model OpenEvent {
  id           String     @id @default(cuid())
  emailEventId String
  emailEvent   EmailEvent @relation(fields: [emailEventId], references: [id], onDelete: Cascade)
  openedAt     DateTime   @default(now())
  ipAddress    String?
  userAgent    String?    @db.Text
  country      String?
  city         String?
  device       String?
  browser      String?
  os           String?

  @@index([emailEventId])
  @@index([openedAt])
}

model ClickEvent {
  id           String     @id @default(cuid())
  emailEventId String
  emailEvent   EmailEvent @relation(fields: [emailEventId], references: [id], onDelete: Cascade)
  linkUrl      String     @db.Text
  clickedAt    DateTime   @default(now())
  ipAddress    String?
  userAgent    String?    @db.Text
  country      String?
  city         String?
  device       String?
  browser      String?
  os           String?

  @@index([emailEventId])
  @@index([clickedAt])
}
